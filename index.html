<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四象限任务管理器 (修复版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-urgent-important: #ef4444; /* Red */
            --color-noturgent-important: #3b82f6; /* Blue */
            --color-urgent-notimportant: #f59e0b; /* Amber */
            --color-noturgent-notimportant: #10b981; /* Emerald */
            font-family: 'Inter', sans-serif;
        }

        .quadrant-grid {
            grid-template-areas:
                "ui uu"
                "di du";
            gap: 1rem;
            min-height: 80vh;
        }

        .quadrant {
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        #quadrant-ui { grid-area: ui; background-color: var(--color-urgent-important); }
        #quadrant-uu { grid-area: uu; background-color: var(--color-noturgent-important); }
        #quadrant-di { grid-area: di; background-color: var(--color-urgent-notimportant); }
        #quadrant-du { grid-area: du; background-color: var(--color-noturgent-notimportant); }

        .quadrant-header {
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .task-list {
            flex-grow: 1;
            padding: 0.5rem 0;
            overflow-y: auto;
            min-height: 100px;
        }

        .task-item {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            word-wrap: break-word;
        }

        .task-item:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .task-title {
            font-weight: 600;
            color: #1f2937;
        }
        
        @media (max-width: 768px) {
            .quadrant-grid {
                grid-template-areas:
                    "ui"
                    "uu"
                    "di"
                    "du";
            }
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">

    <header class="mb-8">
        <h1 class="text-4xl font-bold text-gray-800 text-center">四象限任务管理器 (Eisenhower Matrix)</h1>
        <p class="text-center text-gray-500 mt-1">紧急/重要任务划分与实时同步</p>
        <div id="auth-status" class="text-center mt-2 text-sm text-gray-600"></div>
    </header>

    <!-- 任务创建表单 -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8 max-w-2xl mx-auto">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">新增任务</h2>
        <form id="task-form" class="space-y-4">
            <div>
                <label for="task-title" class="block text-sm font-medium text-gray-700 mb-1">任务名称</label>
                <input type="text" id="task-title" name="title" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                       placeholder="输入任务描述，例如：完成项目报告">
            </div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <div class="flex-1">
                    <label for="task-importance" class="block text-sm font-medium text-gray-700 mb-1">重要性</label>
                    <select id="task-importance" name="importance" required
                            class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="important">重要 (Important)</option>
                        <option value="not-important">不重要 (Not Important)</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="task-urgency" class="block text-sm font-medium text-gray-700 mb-1">紧急度</label>
                    <select id="task-urgency" name="urgency" required
                            class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="urgent">紧急 (Urgent)</option>
                        <option value="not-urgent">不紧急 (Not Urgent)</option>
                    </select>
                </div>
            </div>
            <button type="submit"
                    class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md">
                创建任务
            </button>
        </form>
    </div>

    <!-- 四象限网格 -->
    <main class="quadrant-grid grid grid-cols-1 md:grid-cols-2">
        <div id="quadrant-ui" class="quadrant">
            <div class="quadrant-header">紧急 & 重要 (Do)</div>
            <div class="text-white text-sm mb-2 opacity-90">危机，截止日期驱动的项目</div>
            <div id="task-list-ui" class="task-list"></div>
        </div>
        <div id="quadrant-uu" class="quadrant">
            <div class="quadrant-header">不紧急 & 重要 (Plan)</div>
            <div class="text-white text-sm mb-2 opacity-90">规划，新机会，长期目标</div>
            <div id="task-list-uu" class="task-list"></div>
        </div>
        <div id="quadrant-di" class="quadrant">
            <div class="quadrant-header">紧急 & 不重要 (Delegate)</div>
            <div class="text-white text-sm mb-2 opacity-90">干扰，一些会议，一些邮件</div>
            <div id="task-list-di" class="task-list"></div>
        </div>
        <div id="quadrant-du" class="quadrant">
            <div class="quadrant-header">不紧急 & 不重要 (Eliminate)</div>
            <div class="text-white text-sm mb-2 opacity-90">琐事，时间浪费，休闲活动</div>
            <div id="task-list-du" class="task-list"></div>
        </div>
    </main>

    <!-- 任务删除确认模态框 -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4 text-gray-800">确认删除任务</h3>
            <p class="text-gray-600 mb-6" id="modal-task-title"></p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">取消</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">确认删除</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase 核心 SDK 导入 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            deleteDoc, 
            doc, 
            onSnapshot, 
            query, 
            where 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // =================================================================
        // 修复：使用 Canvas 提供的全局变量进行初始化和认证
        // 部署到 GitHub Pages 等外部平台时，请替换为您的真实配置
        // =================================================================
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 变量声明
        let db, auth;
        let userId = 'loading'; // 初始化为加载状态

        // 元素引用
        const taskForm = document.getElementById('task-form');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete');
        const cancelDeleteButton = document.getElementById('cancel-delete');
        const modalTaskTitle = document.getElementById('modal-task-title');
        const authStatusElement = document.getElementById('auth-status');

        let taskToDelete = null;

        // =================================================================
        // Firebase 初始化和认证
        // =================================================================
        
        try {
            // 设置 Firestore 日志级别为 Debug
            setLogLevel('debug');
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 认证逻辑：优先使用定制令牌，否则使用匿名登录
            const authenticate = async () => {
                try {
                    if (initialAuthToken) {
                        // Canvas 环境使用定制令牌登录
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("使用定制令牌登录成功。");
                    } else {
                        // 外部环境或令牌缺失时使用匿名登录
                        await signInAnonymously(auth);
                        console.log("使用匿名登录成功。");
                    }
                } catch (error) {
                    // 当 API Key 无效时，此处的错误就是您看到的错误
                    console.error("Firebase 认证失败:", error);
                    authStatusElement.textContent = `认证失败: ${error.message}`;
                }
            };
            
            // 监听认证状态变化
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    authStatusElement.textContent = `用户ID: ${userId} (已认证)`;
                    console.log("认证成功，用户ID:", userId);
                    // 认证成功后开始监听数据库
                    setupRealtimeListener();
                } else {
                    userId = 'unauthenticated';
                    authStatusElement.textContent = '未认证，正在尝试登录...';
                    console.log("用户未认证，尝试登录...");
                    authenticate(); // 尝试登录
                }
            });

        } catch (error) {
            console.error("Firebase 初始化失败:", error);
            authStatusElement.textContent = `Firebase 初始化错误: ${error.message}`;
        }
        
        // =================================================================
        // Firestore 数据操作和实时监听
        // =================================================================

        /**
         * 确定任务在 Firestore 中的路径
         * @returns {import('firebase/firestore').CollectionReference}
         */
        function getTaskCollectionRef() {
            // 使用公共路径，允许不同用户共享数据或方便查询
            const collectionPath = `/artifacts/${appId}/public/data/tasks`;
            return collection(db, collectionPath);
        }

        /**
         * 渲染任务到对应的四象限列表
         * @param {Object} task 
         * @param {string} taskId 
         */
        function renderTask(task, taskId) {
            const quadrantKey = getQuadrantKey(task.importance, task.urgency);
            const listElement = document.getElementById(`task-list-${quadrantKey}`);

            // 检查任务是否已存在，防止重复渲染
            let itemElement = document.getElementById(`task-${taskId}`);
            if (itemElement) {
                // 如果已存在，更新内容 (如果需要，本例中只需创建)
                itemElement.querySelector('.task-title').textContent = task.title;
                return; 
            }

            // 创建新的任务元素
            itemElement = document.createElement('div');
            itemElement.id = `task-${taskId}`;
            itemElement.className = 'task-item group flex justify-between items-start';
            itemElement.innerHTML = `
                <span class="task-title flex-1 mr-2">${task.title}</span>
                <button data-id="${taskId}" class="delete-btn text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition duration-150 p-1 rounded-full -m-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            
            // 添加删除按钮事件监听器
            itemElement.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation(); 
                taskToDelete = { id: taskId, title: task.title };
                modalTaskTitle.textContent = `您确定要删除任务：“${task.title}” 吗？`;
                deleteModal.classList.remove('hidden');
                deleteModal.classList.add('flex');
            });

            listElement.appendChild(itemElement);
        }

        /**
         * 移除任务元素
         * @param {string} taskId 
         */
        function removeTask(taskId) {
            const itemElement = document.getElementById(`task-${taskId}`);
            if (itemElement) {
                itemElement.remove();
            }
        }

        /**
         * 设置 Firestore 实时数据监听器
         */
        function setupRealtimeListener() {
            // 如果认证还未就绪，则不进行监听
            if (userId === 'loading' || userId === 'unauthenticated') {
                console.log("等待认证完成才能设置监听器...");
                return;
            }

            const tasksCollectionRef = getTaskCollectionRef();
            const q = query(tasksCollectionRef);
            
            // 清空所有列表内容，防止旧数据残留
            document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');

            onSnapshot(q, (snapshot) => {
                // 存储当前快照中的所有任务ID
                const currentTaskIds = new Set(); 
                
                snapshot.docChanges().forEach((change) => {
                    const taskId = change.doc.id;
                    const taskData = change.doc.data();
                    
                    if (change.type === "added" || change.type === "modified") {
                        // 任务新增或修改
                        renderTask(taskData, taskId);
                        currentTaskIds.add(taskId);
                    } 
                    
                    if (change.type === "removed") {
                        // 任务删除
                        removeTask(taskId);
                    }
                });

                // 移除那些不在当前快照中，但仍然在 DOM 里的元素（清理工作）
                // 这一步对于四象限应用可能不是严格必需，但对于大型应用是有益的
                document.querySelectorAll('.task-item').forEach(item => {
                    const taskId = item.id.substring(5); // task-XXXX
                    if (!currentTaskIds.has(taskId)) {
                        removeTask(taskId);
                    }
                });
            }, (error) => {
                console.error("实时监听失败:", error);
                authStatusElement.textContent = `实时同步错误: ${error.message}`;
            });
        }


        // =================================================================
        // 实用函数
        // =================================================================
        
        /**
         * 根据重要性和紧急度获取象限键 (ui, uu, di, du)
         * @param {string} importance 'important' 或 'not-important'
         * @param {string} urgency 'urgent' 或 'not-urgent'
         * @returns {string} 象限键
         */
        function getQuadrantKey(importance, urgency) {
            // 修正：采用标准的命名习惯来匹配DOM ID (ui, uu, di, du)
            // 我们的DOM ID 是: 
            // - ui: Urgent & Important
            // - uu: Not Urgent & Important
            // - di: Urgent & Not Important
            // - du: Not Urgent & Not Important

            if (urgency === 'urgent' && importance === 'important') return 'ui';
            if (urgency === 'not-urgent' && importance === 'important') return 'uu';
            if (urgency === 'urgent' && importance === 'not-important') return 'di';
            if (urgency === 'not-urgent' && importance === 'not-important') return 'du';
            
            return 'du'; // 默认值
        }

        // =================================================================
        // 事件监听器
        // =================================================================

        /**
         * 处理任务创建表单提交
         * @param {Event} e 
         */
        async function handleAddTask(e) {
            e.preventDefault();
            
            if (userId === 'loading' || userId === 'unauthenticated') {
                 console.warn("认证未完成，无法添加任务。");
                 // 应该使用自定义模态框，但在此处为了调试可见性，使用原生 alert
                 // 警告：在生产代码中避免使用 alert()
                 alert("正在等待认证，请稍后再试。"); 
                 return;
            }

            const title = document.getElementById('task-title').value.trim();
            const importance = document.getElementById('task-importance').value;
            const urgency = document.getElementById('task-urgency').value;

            if (!title) {
                return;
            }

            const newTask = {
                title,
                importance,
                urgency,
                createdAt: new Date().toISOString(),
                createdBy: userId 
            };
            
            try {
                const tasksCollectionRef = getTaskCollectionRef();
                await addDoc(tasksCollectionRef, newTask);
                
                // 清空表单
                taskForm.reset();
                document.getElementById('task-title').focus();
            } catch (error) {
                console.error("添加任务到 Firestore 失败:", error);
                // 警告：在生产代码中避免使用 alert()
                alert(`添加任务失败: ${error.message}`); 
            }
        }

        /**
         * 处理删除任务的确认操作
         */
        async function handleDeleteConfirmed() {
            if (!taskToDelete || !db) return;

            try {
                const docRef = doc(getTaskCollectionRef(), taskToDelete.id);
                await deleteDoc(docRef);
                
                console.log(`任务 ${taskToDelete.id} 已删除。`);
            } catch (error) {
                console.error("从 Firestore 删除任务失败:", error);
                // 警告：在生产代码中避免使用 alert()
                alert(`删除任务失败: ${error.message}`); 
            } finally {
                taskToDelete = null;
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
            }
        }
        
        // 绑定事件
        taskForm.addEventListener('submit', handleAddTask);
        confirmDeleteButton.addEventListener('click', handleDeleteConfirmed);
        cancelDeleteButton.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
            taskToDelete = null;
        });

    </script>
</body>
</html>